<!DOCTYPE html>
<html>
  <head>
    <title>Game</title>
    <script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-release.js"></script>
    <script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-debug-bar-release.js"></script>
    <script type="text/javascript" src="http://cdn.craftycomponents.com/tiledlevel-release.js"></script>
    <script type="text/javascript" src="http://cdn.craftycomponents.com/craftybox-release.js"></script>
  </head>
  <body>
    <script type="text/javascript">
var MAP_GRID = {
  width: 24,
  height: 16,
  tile: {
    width: 16,
    height: 16
  }
};

function gameWidth() {return MAP_GRID.width * MAP_GRID.tile.width;}
function gameHeight() {return MAP_GRID.height * MAP_GRID.tile.height;}

Crafty.c('Grid', {
  init: function() {
    this.attr({w: MAP_GRID.tile.width, h: MAP_GRID.tile.height});
  },

  at: function(x, y) {
    if (x === undefined && y === undefined)
      return {
        x: this.x/MAP_GRID.tile.width,
        y: this.y/MAP_GRID.tile.height
      };
    else {
      this.attr({x: x * MAP_GRID.tile.width, y: y * MAP_GRID.tile.height});
      return this;
    }
  }
});

Crafty.c('Actor', {
  init: function() {this.requires('2D, Canvas, Grid');}
});

Crafty.c('Tree', {
  init: function() {this.requires('Actor, Solid, SprTree');}
});

Crafty.c('Bush', {
  init: function() {this.requires('Actor, Solid, SprBush');}
});

Crafty.c('Rock', {
  init: function() {this.requires('Actor, Solid, SprRock');}
});

Crafty.c('PlayerCharacter', {
  init: function() {
    this.requires('Actor, Fourway, Collision, SprPlayer, SpriteAnimation').fourway(4).stopOnSolids().onHit('Village', this.visitVillage).animate('PlayerMovingUp', 0, 0, 2).animate('PlayerMovingRight', 0, 1, 2).animate('PlayerMovingDown', 0, 2, 2).animate('PlayerMovingLeft', 0, 3, 2);
    var ANIMATION_SPEED = 8;
    this.bind('NewDirection', function(data) {
      if (data.x > 0)
        this.animate('PlayerMovingRight', ANIMATION_SPEED, -1);
      else if (data.x < 0)
        this.animate('PlayerMovingLeft', ANIMATION_SPEED, -1);
      else if (data.y > 0)
        this.animate('PlayerMovingDown', ANIMATION_SPEED, -1);
      else if (data.y < 0)
        this.animate('PlayerMovingUp', ANIMATION_SPEED, -1);
      else this.stop();
    });
  },

  stopOnSolids: function() {
    this.onHit('Solid', this.stopMovement);
    return this;
  },

  stopMovement: function() {
    this._speed = 0;
    if (this._movement) {
      this.x -= this._movement.x;
      this.y -= this._movement.y;
    }
  },

  visitVillage: function(data) {data[0].obj.visit();}
});

Crafty.c('Village', {
  init: function() {this.requires('Actor, SprVillage');},

  visit: function() {
    this.destroy();
    Crafty.audio.play('knock');
    Crafty.trigger('VillageVisited', this);
  }
});

Crafty.scene('Game', function() {
  this.player = Crafty.e('PlayerCharacter').at(5, 5);

  var MAX_VILLAGES = 5;

  for (var x=0; x<MAP_GRID.width; ++x) {
    for (var y=0; y<MAP_GRID.height; ++y) {
      if (x == 5 && y == 5) continue;
      if (x == 0 || x == MAP_GRID.width - 1 || y == 0 || y == MAP_GRID.height - 1)
        Crafty.e('Tree').at(x, y);
      else if (Math.random() < 0.06) {
        var bushOrRock = Math.random() > 0.3 ? 'Bush' : 'Rock';
        Crafty.e(bushOrRock).at(x, y);
      } else if (Crafty('Village').length < MAX_VILLAGES && Math.random() < 0.02)
        Crafty.e('Village').at(x, y);
    }
  }

  Crafty.audio.play('ring');

  this.showVictory = this.bind('VillageVisited', function() {
    if (!Crafty('Village').length) Crafty.scene('Victory');
  });
}, function() {this.unbind('VillageVisited', this.showVictory);});

Crafty.scene('Victory', function() {
  Crafty.e('2D, DOM, Text').attr({x: 0, y: 0}).text('Victory!');
  Crafty.audio.play('applause');
  var delay = true;
  setTimeout(function() {delay = false;}, 5000);
  this.restartGame = this.bind('KeyDown', function() {
    if (!delay) Crafty.scene('Game');
  });
}, function() {this.unbind('KeyDown', this.restartGame);});

Crafty.scene('Loading', function() {
  Crafty.e('2D, DOM, Text').text('Loading...').attr({x: 0, y: gameHeight()/2 - 24, w: gameWidth()});
  Crafty.load(['assets/16x16_forest_1.gif',
               'assets/hunter.png',
               'assets/door_knock_3x.mp3',
               'assets/door_knock_3x.ogg',
               'assets/board_room_applause.mp3',
               'assets/board_room_applause.ogg',
               'assets/candy_dish_lid.mp3',
               'assets/candy_dish_lid.ogg'], function() {
    Crafty.sprite(16, 'assets/16x16_forest_2.gif', {
      SprTree: [0, 0],
      SprBush: [1, 0],
      SprVillage: [0, 1],
      SprRock: [1, 1]
    });
    Crafty.sprite(16, 'assets/hunter.png', {
      SprPlayer: [0, 2]
    }, 0, 2);
    Crafty.audio.add({knock:    ['assets/door_knock_3x.mp3',
                                 'assets/door_knock_3x.ogg'],
                      applause: ['assets/board_room_applause.mp3',
                                 'assets/board_room_applause.ogg'],
                      ring:     ['assets/candy_dish_lid.mp3',
                                 'assets/candy_dish_lid.ogg']});
    Crafty.scene('Game');
  });
});

Crafty.modules({'crafty-debug-bar': 'release'}, function () {
  Crafty.debugBar.show();
});

Crafty.init(gameWidth(), gameHeight());
Crafty.background('rgb(87, 109, 20)');
Crafty.scene('Loading');
    </script>
  </body>
</html>
