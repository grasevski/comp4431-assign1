<!DOCTYPE html>
<html>
  <head>
    <title>Michael Caine Racing</title>
    <script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-release.js"></script>
  </head>
  <body>
    <script type="text/javascript">
// Constants
var GAME = {width: 640, height: 480, dv: 0.2, maxv: 5, minv: -3, dtheta: 5, friction: 0.1};

// Components
Crafty.c('Actor', {
  init: function() {this.requires('2D, Canvas, Color');}
});

Crafty.c('Coin', {
  init: function() {
    this.dx = 0;
    this.dy = 0;
    this.requires('Actor')
      .attr({w: 10, h: 10})
      .requires('Collision').onHit('Enemy', this.hitEnemy)
      .color('yellow')
      .bind('EnterFrame', function() {
      if (this.color() == 'orange') return;
      this.dx = this.dy = 0;
      if (Math.random() < 0.5) ++this.dx;
      if (Math.random() < 0.5) --this.dx;
      if (Math.random() < 0.5) ++this.dy;
      if (Math.random() < 0.5) --this.dy;
      this.x += this.dx;
      this.y += this.dy;
    });
  },

  hitEnemy: function() {
    this.x -= this.dx;
    this.y -= this.dy;
  }
});

Crafty.c('Enemy', {
  init: function() {
    this.requires('Actor')
      .attr({w: 10, h: 10})
      .color('red');
  }
});

Crafty.c('PlayerCharacter', {
  init: function() {
    this.v = 0;
    this.turningDirection = 0;
    this.requires('Actor, Keyboard')
      .attr({w: 20, h: 30, z: 1})
      .origin('center')
      .requires('Collision').onHit('Coin', this.collectCoin).onHit('Enemy', this.hitEnemy)
      .color('blue')
      .bind('EnterFrame', function() {
      if (this.isDown(Crafty.keys.UP_ARROW)) this.v += GAME.dv;
      else if (this.isDown(Crafty.keys.DOWN_ARROW)) this.v -= GAME.dv;
      else if (this.v > 0) this.v = Math.max(this.v-GAME.friction, 0);
      else if (this.v < 0) this.v = Math.min(this.v+GAME.friction, 0);
      this.v = Math.max(Math.min(this.v, GAME.maxv), GAME.minv);
      this.x += Math.sin(this._rotation * Math.PI/180) * this.v;
      this.y -= Math.cos(this._rotation * Math.PI/180) * this.v;
      if (this.v == 0) this.turningDirection = 0;
      else if (this.isDown(Crafty.keys.LEFT_ARROW))
        this.turningDirection = -1;
      else if (this.isDown(Crafty.keys.RIGHT_ARROW))
        this.turningDirection = 1;
      else this.turningDirection = 0;
      if (this.v < 0) this.turningDirection *= -1;
      this.rotation = (this.rotation + this.turningDirection*GAME.dtheta) % 360;
    });
  },

  collectCoin: function(data) {
    for (var i=0; i<data.length; ++i) data[i].obj.color('orange');
  },

  hitEnemy: function(data) {
    this.rotation -= this.turningDirection * GAME.dtheta;
    this.x -= Math.sin(this._rotation * Math.PI/180) * this.v;
    this.y += Math.cos(this._rotation * Math.PI/180) * this.v;
    this.v = 0;
  }
});


// Scenes
Crafty.scene('Loading', function() {
  Crafty.e('2D, DOM, Text')
    .text('Loading; please wait...');
  Crafty.load(['sprites.png',
    'coin.mp3', 'enemy.mp3', 'player.mp3', 'bg.mp3'], function() {
    //Crafty.sprite(16, 'sprites.png', {
    //  spr_coin: [0, 2], spr_enemy; [0, 4], spr_player: [0, 7]
    //});
    Crafty.audio.add({bg: 'bg.mp3',
      coin: 'coin.mp3', enemy: 'enemy.mp3', player: 'player.mp3'});
    Crafty.audio.play('bg', -1);
    Crafty.scene('Game');
  });
});

Crafty.scene('Game', function() {
  //Crafty.background("url('bg.png')");
  var w = GAME.width, h = GAME.height;
  var e = Crafty.e('PlayerCharacter');
  e.attr({x: Math.random() * (w-e.w), y: Math.random() * (h-e.h)});
  while (Math.random() < 0.9) {
    if (Math.random() < 0.9) {
      e = Crafty.e('Coin');
      e.attr({x: Math.random() * (w-e.w),
              y: Math.random() * (h-e.h)});
      if (e.hit('Coin') || e.hit('Enemy') || e.hit('PlayerCharacter'))
        e.destroy();
    } else {
      e = Crafty.e('Enemy');
      e.attr({x: Math.random() * (w-e.w),
              y: Math.random() * (h-e.h)});
      if (e.hit('Coin') || e.hit('Enemy') || e.hit('PlayerCharacter'))
        e.destroy();
    }
  }
});

Crafty.scene('Victory', function() {
});

Crafty.scene('Defeat', function() {
});


// Game
Crafty.init(GAME.width, GAME.height);
Crafty.background('green');
Crafty.scene('Loading');
    </script>
  </body>
</html>
